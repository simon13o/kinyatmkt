import streamlit as st
import pandas as pd
import time # ç”¨äºæ¨¡æ‹Ÿä¸Šä¼ å»¶è¿Ÿ

# --- é¡µé¢é…ç½® (Page Configuration) ---
# Streamlit does not use Tailwind but allows for custom HTML/CSS if needed.
st.set_page_config(
    page_title="MarketSight: OEM/ODM å•†ä¸šæƒ…æŠ¥å¹³å°",
    page_icon="ğŸ“ˆ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- æ¨¡æ‹Ÿæ•°æ® (Mock Data Setup) ---

# 1. é”€å”®æ•°æ®æ¨¡æ‹Ÿ (OEM/ODM/JDM)
sales_data_df = pd.DataFrame([
    {'Month': 'Jan', 'Revenue': 450, 'Inquiries': 24, 'Conversion': 12},
    {'Month': 'Feb', 'Revenue': 520, 'Inquiries': 28, 'Conversion': 14},
    {'Month': 'Mar', 'Revenue': 480, 'Inquiries': 35, 'Conversion': 11},
    {'Month': 'Apr', 'Revenue': 610, 'Inquiries': 42, 'Conversion': 18},
    {'Month': 'May', 'Revenue': 550, 'Inquiries': 38, 'Conversion': 15},
    {'Month': 'Jun', 'Revenue': 720, 'Inquiries': 50, 'Conversion': 22},
])

# 2. äº§å“å“ç±»å…´è¶£åˆ†å¸ƒ (ç”¨äºé¥¼å›¾)
category_data_df = pd.DataFrame([
    {'Category': 'Bottle Washers', 'Value': 35},
    {'Category': 'Sterilizers', 'Value': 25},
    {'Category': 'Formula Makers', 'Value': 20},
    {'Category': 'Kitchen Apps', 'Value': 20},
])

# 3. æŠ¥å‘Šåº“æ¨¡æ‹Ÿ (PDFs)
reports_df = pd.DataFrame([
    {'Title': '2024 æ¯å©´ç”µå­äº§å“è¶‹åŠ¿æŠ¥å‘Š', 'Type': 'Market Research', 'Date': '2023-10-15', 'Tags': 'Bottle Washer, UV Sterilizer', 'Summary': 'ä¾¿æºå¼ä¸æ™ºèƒ½åŒ–æˆä¸ºæ¬§ç¾å¸‚åœºæ ¸å¿ƒå¢é•¿ç‚¹ã€‚'},
    {'Title': 'åŒ—ç¾å¨æˆ¿å°å®¶ç”µç«äº‰æ ¼å±€åˆ†æ', 'Type': 'Competitor Analysis', 'Date': '2023-11-02', 'Tags': 'Kitchen, OEM', 'Summary': 'å¤´éƒ¨å“ç‰Œæ­£åœ¨å¯»æ‰¾å…·æœ‰IoTåŠŸèƒ½çš„ä»£å·¥å‚ã€‚'},
    {'Title': 'Q3 æœç´¢æµé‡å…³é”®è¯åˆ†æ (SEO)', 'Type': 'Marketing', 'Date': '2023-11-20', 'Tags': 'SEO, SEM', 'Summary': '"Portable Formula Maker" æœç´¢é‡ç¯æ¯”å¢é•¿ 45%ã€‚'},
    {'Title': 'æ¬§æ´² JDM åˆä½œæœºä¼šè°ƒç ”', 'Type': 'Strategy', 'Date': '2023-12-01', 'Tags': 'JDM, Europe', 'Summary': 'å¾·å›½ä¸æ³•å›½çš„ä¸­ç«¯å“ç‰Œå­˜åœ¨ä¾›åº”é“¾æ›¿ä»£éœ€æ±‚ã€‚'},
])

# 4. å±•ä¼šæ•°æ®æ¨¡æ‹Ÿ
events_df = pd.DataFrame([
    {'Name': 'CES 2024', 'Location': 'Las Vegas, USA', 'Date': '2024-01-09', 'Status': 'High Priority', 'Focus': 'Smart Home & Baby Tech', 'Leads Target': 50},
    {'Name': 'Ambiente', 'Location': 'Frankfurt, Germany', 'Date': '2024-02-26', 'Status': 'Planned', 'Focus': 'Kitchen Lifestyle', 'Leads Target': 30},
    {'Name': 'CBME China', 'Location': 'Shanghai', 'Date': '2024-07-14', 'Status': 'Reviewing', 'Focus': 'Maternal & Child', 'Leads Target': 80},
    {'Name': 'IFA Berlin', 'Location': 'Berlin', 'Date': '2024-09-06', 'Status': 'Upcoming', 'Focus': 'Consumer Electronics', 'Leads Target': 60},
])

# --- ä¾§è¾¹æ  (Sidebar Navigation) ---

st.sidebar.title("ğŸ“ˆ MarketSight")
st.sidebar.markdown("---")
st.sidebar.subheader("OEM/ODM å•†ä¸šæƒ…æŠ¥å¹³å°")

# å¯¼èˆªé€‰æ‹©
app_mode = st.sidebar.radio(
    "å¯¼èˆª",
    ("æ•°æ®æ€»è§ˆ (Dashboard)", "è°ƒç ”æŠ¥å‘Šåº“ (Reports)", "é”€å”®åˆ†æ (Sales)", "å±•ä¼šé›·è¾¾ (Events)")
)

st.sidebar.markdown("---")
st.sidebar.markdown("**ç”¨æˆ·:** Business Analyst")


# --- 1. æ•°æ®æ€»è§ˆ (Dashboard View) ---
if app_mode == "æ•°æ®æ€»è§ˆ (Dashboard)":
    st.title("ğŸ“Š æ•°æ®æ€»è§ˆ - æœ¬å‘¨å¸‚åœºåŠ¨æ€")
    st.markdown("è¿™æ˜¯æœ¬å‘¨çš„å¸‚åœºåŠ¨æ€æ¦‚è§ˆï¼Œå¸®åŠ©ç®¡ç†å±‚å¿«é€Ÿäº†è§£å…³é”®ç»©æ•ˆæŒ‡æ ‡ã€‚")
    st.markdown("---")

    # KPI Metrics
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric(
            label="OEM æ½œåœ¨è¯¢ç›˜ (YTD)",
            value="217",
            delta="12.5% è¾ƒä¸Šæœˆ",
            delta_color="normal"
        )
    with col2:
        st.metric(
            label="å·²å½’æ¡£è°ƒç ”æŠ¥å‘Š",
            value=len(reports_df),
            delta="æœ¬æœˆæ–°å¢ 2 ä»½",
            delta_color="off"
        )
    with col3:
        st.metric(
            label="å³å°†å‚åŠ å±•ä¼š",
            value=len(events_df),
            help="ä¸‹ä¸€ç«™: CES 2024",
            delta_color="off"
        )

    st.markdown("## ğŸ“ˆ è¯¢ç›˜ä¸è¥æ”¶è¶‹åŠ¿")
    st.line_chart(
        sales_data_df, 
        x='Month', 
        y=['Revenue', 'Inquiries'],
        height=350,
        color={
            'Revenue': '#3b82f6', # è“è‰²
            'Inquiries': '#10b981' # ç»¿è‰²
        }
    )

    st.markdown("## ğŸ¥§ äº§å“å“ç±»å…´è¶£åˆ†å¸ƒ (åŸºäº SEM)")
    # Streamlit built-in pie chart
    st.altair_chart(
        st.session_state.get('category_chart', None),
        use_container_width=True
    )
    # Using Plotly for better pie chart control (optional, but good for portfolio)
    # import plotly.express as px
    # fig = px.pie(category_data_df, values='Value', names='Category', title='äº§å“å“ç±»å…´è¶£åˆ†å¸ƒ')
    # st.plotly_chart(fig, use_container_width=True)

# --- 2. è°ƒç ”æŠ¥å‘Šåº“ (Reports View) ---
elif app_mode == "è°ƒç ”æŠ¥å‘Šåº“ (Reports)":
    st.title("ğŸ“‚ å¸‚åœºè°ƒç ”æŠ¥å‘Šåº“")
    st.markdown("é›†ä¸­ç®¡ç†æ‰€æœ‰ PDF è¡Œä¸šåˆ†ææ–‡æ¡£ã€‚")
    st.markdown("---")

    # åˆå§‹åŒ–çŠ¶æ€ç”¨äºæŠ¥å‘Šä¸Šä¼ 
    if 'reports_df' not in st.session_state:
        st.session_state.reports_df = reports_df.copy()
    
    # æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ
    st.subheader("ğŸ“ ä¸Šä¼ æ–°æŠ¥å‘Š")
    uploaded_file = st.file_uploader(
        "é€‰æ‹© PDF æ–‡ä»¶ä¸Šä¼ ", 
        type=['pdf'], 
        accept_multiple_files=False, 
        help="ä»…æ”¯æŒ PDF æ ¼å¼çš„å¸‚åœºè°ƒç ”æŠ¥å‘Šã€‚"
    )

    if uploaded_file is not None:
        if st.button("ğŸš€ ç¡®è®¤ä¸Šä¼ å¹¶å¤„ç†"):
            with st.spinner(f'æ­£åœ¨ä¸Šä¼ å¹¶åˆ†ææŠ¥å‘Š "{uploaded_file.name}"ï¼Œè¯·ç¨å€™...'):
                time.sleep(2) # æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿå’Œåå°å¤„ç†
            
            # æ¨¡æ‹Ÿæ–‡ä»¶å¤„ç†æˆåŠŸï¼Œå¹¶æ·»åŠ åˆ°æŠ¥å‘Šåˆ—è¡¨ä¸­
            new_report = {
                'Title': uploaded_file.name.replace('.pdf', ''),
                'Type': 'New Submission',
                'Date': time.strftime("%Y-%m-%d"),
                'Tags': 'New, Uncategorized',
                'Summary': 'æ–°ä¸Šä¼ çš„æŠ¥å‘Šï¼Œç­‰å¾…å•†ä¸šåˆ†æå‘˜æ‘˜è¦ã€‚'
            }
            # æ›´æ–° session state ä¸­çš„ DataFrame
            new_reports_df = pd.DataFrame([new_report])
            st.session_state.reports_df = pd.concat([new_reports_df, st.session_state.reports_df], ignore_index=True)
            
            st.success(f"âœ… æŠ¥å‘Š \"{uploaded_file.name}\" ä¸Šä¼ æˆåŠŸï¼Œå·²æ·»åŠ åˆ°æŠ¥å‘Šåº“é¡¶éƒ¨ã€‚")

    st.markdown("---")
    st.subheader("ğŸ“š æŠ¥å‘Šåˆ—è¡¨")
    
    # æœç´¢å’Œç­›é€‰
    search_query = st.text_input("æœç´¢å…³é”®è¯æˆ–æ ‡ç­¾:", "")
    
    # ç­›é€‰æŠ¥å‘Š
    if search_query:
        filtered_df = st.session_state.reports_df[
            st.session_state.reports_df.apply(lambda row: search_query.lower() in str(row).lower(), axis=1)
        ]
    else:
        filtered_df = st.session_state.reports_df

    # æ˜¾ç¤ºæŠ¥å‘Šåˆ—è¡¨
    for index, row in filtered_df.iterrows():
        col_title, col_summary, col_date = st.columns([3, 5, 2])
        
        with col_title:
            st.markdown(f"**{row['Title']}**")
            st.markdown(f"<span style='color: #3b82f6; font-size: 12px;'>{row['Type']}</span>", unsafe_allow_html=True)
        
        with col_summary:
            st.markdown(f"<span style='color: #64748b; font-size: 14px;'>{row['Summary']}</span>", unsafe_allow_html=True)
            st.markdown(f"<span style='color: #a1a1aa; font-size: 10px;'>æ ‡ç­¾: {row['Tags']}</span>", unsafe_allow_html=True)
            
        with col_date:
            st.markdown(f"<div style='text-align: right;'>{row['Date']}</div>", unsafe_allow_html=True)
            st.download_button(
                label="â¬‡ï¸ ä¸‹è½½ PDF",
                data="æ¨¡æ‹Ÿä¸‹è½½å†…å®¹ï¼ŒçœŸå®é¡¹ç›®ä¸­éœ€è¿æ¥äº‘å­˜å‚¨ã€‚",
                file_name=f"{row['Title']}.pdf",
                mime="application/pdf"
            )
        st.markdown("---")

# --- 3. é”€å”®åˆ†æ (Sales View) ---
elif app_mode == "é”€å”®åˆ†æ (Sales)":
    st.title("ğŸ’¸ é”€å”®æ•°æ®æ·±åº¦åˆ†æ")
    st.markdown("å°† Excel é”€å”®æ•°æ®è½¬åŒ–ä¸ºç›´è§‚å›¾è¡¨ï¼Œè¾…åŠ© BD å›¢é˜Ÿåˆ¶å®šç­–ç•¥ã€‚")
    st.markdown("---")

    # æ¨¡æ‹Ÿå¯¼å…¥ Excel æ•°æ®çš„åŒºåŸŸ
    st.subheader("âš™ï¸ é”€å”®æ•°æ®å¯¼å…¥çŠ¶æ€")
    st.info("æ•°æ®å·²ä»æ¨¡æ‹Ÿçš„ Excel æ–‡ä»¶è‡ªåŠ¨åŠ è½½ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæ­¤åŒºåŸŸå¯æ·»åŠ  Excel æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ã€‚")

    # è¯¢ç›˜/è½¬åŒ–ç‡è¡¨æ ¼ (Summary Table)
    st.subheader("ğŸ“Š è¯¢ç›˜ä¸è½¬åŒ–ç‡æ±‡æ€»")
    st.dataframe(
        sales_data_df,
        use_container_width=True,
        hide_index=True
    )

    # è¯¦ç»†å›¾è¡¨ï¼šè½¬åŒ–ç‡ä¸è¥æ”¶
    st.subheader("ğŸ“ˆ è½¬åŒ–ç‡ä¸è¥æ”¶è¶‹åŠ¿å¯¹æ¯”")
    
    col_chart1, col_chart2 = st.columns(2)
    
    with col_chart1:
        st.markdown("**æœˆåº¦è¥æ”¶ (k$)**")
        st.bar_chart(sales_data_df, x='Month', y='Revenue', color='#3b82f6')
        
    with col_chart2:
        st.markdown("**æœˆåº¦è½¬åŒ–ç‡ (%)**")
        st.area_chart(sales_data_df, x='Month', y='Conversion', color='#10b981')

# --- 4. å±•ä¼šé›·è¾¾ (Events View) ---
elif app_mode == "å±•ä¼šé›·è¾¾ (Events)":
    st.title("ğŸ—ºï¸ å…¨çƒå±•ä¼šä¸æœºä¼šé›·è¾¾")
    st.markdown("è¿½è¸ªå‚å±•è®¡åˆ’ï¼Œå¿«é€Ÿè¯†åˆ«æ½œåœ¨ JDM åˆä½œä¼™ä¼´æœºä¼šã€‚")
    st.markdown("---")

    st.subheader("ğŸ—“ï¸ å³å°†åˆ°æ¥çš„é‡è¦å±•ä¼š")
    
    # å±•ä¼šåˆ—è¡¨
    st.dataframe(
        events_df,
        use_container_width=True,
        hide_index=True,
        column_config={
            "Status": st.column_config.BadgeColumn(
                "çŠ¶æ€",
                help="å±•ä¼šå‡†å¤‡çŠ¶æ€",
                width="small",
                # Mapping colours for visual clarity
                default_color="gray",
                options={
                    "High Priority": "red",
                    "Planned": "blue",
                    "Reviewing": "yellow",
                    "Upcoming": "green",
                }
            ),
             "Leads Target": st.column_config.ProgressColumn(
                 "çº¿ç´¢ç›®æ ‡è¿›åº¦",
                 help="çº¿ç´¢ç›®æ ‡è¿›åº¦ (æ¨¡æ‹Ÿå€¼)",
                 format="%f",
                 min_value=0,
                 max_value=100,
             )
        }
    )

    st.markdown("---")
    st.subheader("ğŸ’¡ å±•ä¼šç­–ç•¥æ´å¯Ÿ")
    
    st.error("""
    **CES 2024 (æ‹‰æ–¯ç»´åŠ æ–¯):**
    é‡ç‚¹æ¨å¹¿ **æ¯å©´ç”µå­äº§å“** ä¸­çš„æ™ºèƒ½åŒ–åŠŸèƒ½ï¼ˆWi-Fi è¿æ¥ï¼ŒApp æ§åˆ¶ï¼‰ï¼Œä»¥å¸å¼•åŒ—ç¾é«˜ç§‘æŠ€æ¯å©´å“ç‰Œè¿›è¡Œ **JDM åˆä½œ**ã€‚
    """)

    st.warning("""
    **Ambiente (æ³•å…°å…‹ç¦):**
    æ¬§æ´²å¸‚åœºå¯¹ **å¨æˆ¿å®¶ç”µ** çš„å“è´¨è¦æ±‚é«˜ï¼Œå»ºè®®çªå‡º **ODM** æ–¹æ¡ˆä¸­çš„è€ç”¨æ€§å’Œèƒ½è€—æ•ˆç‡ï¼Œä»¥æ»¡è¶³æ¬§æ´²çš„ç¯ä¿æ³•è§„ã€‚
    """)

# --- Initializing chart data in session state for Streamlit (for best practice) ---
if 'category_chart' not in st.session_state:
    import plotly.express as px
    st.session_state.category_chart = px.pie(
        category_data_df, 
        values='Value', 
        names='Category', 
        title='äº§å“å“ç±»å…´è¶£åˆ†å¸ƒ',
        color_discrete_sequence=['#3b82f6', '#10b981', '#f59e0b', '#6366f1']
    )
    st.session_state.category_chart.update_layout(showlegend=True)